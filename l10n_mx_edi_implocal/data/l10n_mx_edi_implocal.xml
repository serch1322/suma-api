<?xml version="1.0" encoding="UTF-8"?>

<odoo>
    <template inherit_id="l10n_mx_edi.cfdiv33" id="l10n_mx_edi_implocal">
        <xpath position="after" expr="//t[@t-set='taxes_line']">
            <t t-value="taxes_line.filtered(lambda r: r.invoice_repartition_line_ids.tag_ids and r.invoice_repartition_line_ids.tag_ids[0].name.lower() != 'local')" t-set="taxes_line"/>
        </xpath>
        <xpath position="after" expr="//*[local-name()='Conceptos']">
            <t t-value="[value for value in record.invoice_line_ids.mapped('tax_ids').filtered(lambda r: r.invoice_repartition_line_ids.filtered(lambda rep: rep.tag_ids and rep.tag_ids[0].name.lower() == 'local') and r.amount >= 0)]" t-set="transferred_local"/>
            <t t-value="[value for value in record.invoice_line_ids.mapped('tax_ids').filtered(lambda r: r.invoice_repartition_line_ids.filtered(lambda rep: rep.tag_ids and rep.tag_ids[0].name.lower() == 'local') and r.amount < 0)]" t-set="withholding_local"/>
            <t t-value="sum((value.amount / 100) * float(record.amount_untaxed) for value in transferred_local) or 0.00" t-set="total_transferred_local"/>
            <t t-value="sum((abs(value.amount) / 100) * float(record.amount_untaxed) for value in withholding_local) or 0.00" t-set="total_withhold_local"/>
            <t t-value="{'total_withhold': taxes['total_withhold'] - total_withhold_local, 'total_transferred': taxes['total_transferred'] - total_transferred_local, 'withholding': [value for value in taxes['withholding'] if value['name'].lower() != 'local'] if taxes['withholding'] else taxes['withholding'], 'transferred': [value for value in taxes['transferred'] if value['name'].lower() != 'local'] if taxes['transferred'] else taxes['transferred']}" t-set="taxes"/>
        </xpath>
        <xpath position="before" expr="(//*[local-name()='Traslado'])[2]">
            <t t-value="sum(abs(value.amount) for value in transferred_local if abs(value.amount) == transferred['rate']) / 100 * record.amount_untaxed" t-set="local_amount_transferred"/>
        </xpath>
        <xpath position="attributes" expr="(//*[local-name()='Traslado'])[2]">
            <attribute name="t-att-Importe">'%.*f' % (decimal_precision, transferred['amount'] - local_amount_transferred if local_amount_transferred else transferred['amount']) or 0.00</attribute>
        </xpath>
        <xpath position="before" expr="(//*[local-name()='Retencion'])[2]">
            <t t-value="sum(abs(value.amount) for value in withholding_local if abs(value.amount) == withhold['rate']) / 100 * record.amount_untaxed" t-set="local_amount_withhold"/>
        </xpath>
        <xpath position="attributes" expr="(//*[local-name()='Retencion'])[2]">
            <attribute name="t-att-Importe">'%.*f' % (decimal_precision, withhold['amount'] - local_amount_withhold if local_amount_withhold else withhold['amount']) or 0.00</attribute>
        </xpath>
        <xpath position="inside" expr="*">
            <t t-if="record.invoice_line_ids.mapped('tax_ids.invoice_repartition_line_ids').filtered(lambda r: r. tag_ids and r.tag_ids[0].name.lower() == 'local')">
                <cfdi:Complemento xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:cfdi="http://www.sat.gob.mx/cfd/3">
                    <implocal:ImpuestosLocales t-att-TotaldeTraslados="'%.*f' % (decimal_precision, total_transferred_local)" t-att-TotaldeRetenciones="'%.*f' % (decimal_precision, total_withhold_local)" version="1.0" xmlns:implocal="http://www.sat.gob.mx/implocal" xsi:schemaLocation="http://www.sat.gob.mx/implocal http://www.sat.gob.mx/sitio_internet/cfd/implocal/implocal.xsd">
                        <t t-if="transferred_local">
                            <t t-as="tax" t-foreach="transferred_local">
                                <implocal:TrasladosLocales t-att-Importe="'%.2f' % (abs(tax.amount) / 100 * float(record.amount_untaxed)) " t-att-TasadeTraslado="'%.6f' % round(abs(tax.amount), 2)" t-att-ImpLocTrasladado="tax.name"/>
                            </t>
                        </t>
                        <t t-if="withholding_local">
                            <t t-as="tax" t-foreach="withholding_local">
                                <implocal:RetencionesLocales t-att-Importe="'%.2f' % (abs(tax.amount)) " t-att-TasadeRetencion="0.00" t-att-ImpLocRetenido="tax.name"/>
                            </t>
                         </t>
                    </implocal:ImpuestosLocales>
                </cfdi:Complemento>
            </t>
        </xpath>
    </template>
</odoo>
